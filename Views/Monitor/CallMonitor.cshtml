@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="col-md-12 my-4">
    <div class="card shadow">
        <div class="card-body">
            <h5 class="card-title">  </h5>
            <div class="row">
                <div class="form-group col-md-6">
                    <label for="ProgramID">Audit Type</label>
                    @Html.DropDownList("AuditID", (List<SelectListItem>)ViewBag.AuditTypeList, "Select AditType", new { @class = "custom-select", id = "AuditID", onchange ="OnAuditChange()"})
                </div>

                <div class="form-group col-md-6">
                    <label for="ProgramID">Select Program</label>
                    @Html.DropDownList("ProgramID", (List<SelectListItem>)ViewBag.Process, "Select Program", new { @class = "custom-select", id = "ProgramID", onchange = "onProgramChange()" })
                </div>
                <div class="form-group col-md-6">
                    <label for="SUBProgramID">Sub Program Name</label>
                    <select name="SUBProgramID" id="SUBProgramID" class="custom-select" onchange="onSubProgramChange()">
                    </select>
                </div>

                <div class="form-group col-md-6" id="DispoID"style="display:none">
                    <label for="dispositionId">Disposition</label>
                    <select name="dispositionId" id="dispositionId" class="custom-select" onchange="onDispositionChange()">
                    </select>
                </div>
                <div class="form-group col-md-6" id="SUBDispoID" style="display:none">
                    <label for="SubDispositionID">Sub Disposition</label>
                    <select name="SubDispositionID" id="SubDispositionID" class="custom-select">
                    </select>
                </div>


            </div>
        </div>
    </div>
</div>




<div class="col-md-12 my-4">
    <div class="card shadow">
        <div class="card-body">
            <h5 class="card-title"> Search Recording </h5>
            <div class="row">

                <div class="form-group col-md-6">
                    <label for="FromDate">From Date</label>
                    <input type="date" id="FromDate" class="custom-select">
                </div>

                <div class="form-group col-md-6">
                    <label for="ToDate">To Date</label>
                    <input type="date" id="Todate" class="custom-select">
                </div>
             
                <div class="form-group col-md-6">
                    <label for="AgentID">Agent Name</label>
                    <select name="AgentID" id="AgentID" class="custom-select" onchange="onAgentIDChange()">
                    </select>
                </div>

                <div class="form-group col-md-6">
                    <label for="TL_id">TL Name</label>
                    <input type="text" placeholder="TL Name" class="custom-select" id="TL_id" readonly />
                </div>

                 <div class="form-group col-md-6">
                    <label for="ConnID">Transaction_ID</label>
                    <input type="text" class="form-control" id="Transaction_ID" aria-describedby="button-addon2" readonly>

                </div>

                 <div class="form-group col-md-6">
                    <label for="Monitored_date">Monitored date</label>
                    <input type="text" class="form-control" id="Monitored_date" aria-describedby="button-addon2" readonly>

                </div>

                <div class="form-group col-md-6">
                    <label for="Transaction_Date">Transaction Date</label>
                    <input type="text" class="form-control" id="Transaction_Date" aria-describedby="button-addon2" readonly>

                </div>
                <div class="form-group col-md-6">
                    <label for="Year">Year</label>
                    <input type="text" class="form-control" id="Year" aria-describedby="button-addon2" readonly>

                </div>
                <div class="form-group col-md-6">
                    <label for="Month">Month</label>
                    <input type="text" class="form-control" id="Month" aria-describedby="button-addon2" readonly>

                </div>
                <div class="form-group col-md-6">
                    <label for="Week">Week</label>
                    <input type="text" class="form-control" id="Week" aria-describedby="button-addon2" readonly>

                </div>

            </div>
        </div>
    </div>
</div>



<div id="recordingContainer"></div>
<div class="row">
    <div class="col-md-6 my-4" id="RelListDiv" style="display:none">
        <div class="card shadow">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="w-40">Agent ID</th>
                                <th class="w-40">Transaction ID</th>
                                <th class="w-40">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="recTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 my-4" id="LastReansaction" style="display:none">
        <div class="card shadow">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                              
                                <th class="w-40">ID</th>
                                <th class="w-40">Transaction ID</th>
                                <th class="w-40">CQ_Score</th>
                            </tr>
                        </thead>
                        <tbody id="lastRecTableBody">
                            @if (ViewBag.LastTransaction != null)
                            {
                                foreach (System.Data.DataRow row in ViewBag.LastTransaction.Rows)
                                {
                                    <tr>
                                        <td>@row["ID"]</td>
                                        <td>@row["TransactionID"]</td>
                                        <td>@row["CQ_Score"]</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center">No data available</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div> 
                <div>

                    <div class="col-md-12">
                        <div class="form-group mb-3 d-flex align-items-center justify-content-start gap-4"
                             style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">

                            <button id="StartAudit" class="btn btn-primary" onclick="startAudit()"
                                    style="padding: 10px 20px; font-size: 16px;">
                                Start Audit
                            </button>

                            <button id="pauseButton" onclick="togglePause()"
                                    style="display: flex; align-items: center; justify-content: center;margin-left:20px; width: 50px; height: 50px; border: none; border-radius: 50%; background: linear-gradient(135deg, #007bff, #0056b3); color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;"
                                    disabled>
                                <i id="pauseIcon" class="fe fe-24 fe-play"></i>
                            </button>

                            <span id="timer" style="font-size: 20px; font-weight: bold; min-width: 70px; text-align: center;">
                                00:00
                            </span>

                            <span id="pauseCount" style="font-size: 16px; font-weight: bold; min-width: 90px;">
                                Pauses: 0
                            </span>
                            <span id="pauseLimit" style="font-size: 16px; font-weight: bold; min-width: 100px;">
                                Limit Of Pauses:
                            </span>

                          
                        </div>
                    </div>
                   
                </div>
            </div>
        </div>
    </div>
</div>


<div class="card shadow mb-4" id="SectionGried" style="display:none">
    <div class="card-header">
        <strong class="card-title"> Section</strong>

    </div>
    <div class="card-body">

        <table id="sectionGrid" class="table table-bordered">
            <thead>
                <tr>

                    <th>Category</th>
                    <th>Level</th>
                    <th>Section Name</th>
                    <th>QA Rating</th>
                    <th>Scorable</th>

                    <th>Weightage</th>
                    <th>Comments Section</th>

                    

                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
</div>




<div class="card shadow mb-4" id="rooutcause" style="display:none">
    <div class="card-header">
        <strong class="card-title">Root Cause Analysis</strong>
       
    </div>
    <div class="card-body">
        <div class="row">
            <table id="rootCauseTable" class="table table-bordered">
                <thead>
                    <tr>
                      
                        <th>Metric RCA</th>
                        <th>Controllable</th>
                        <th>RCA 1</th>
                        <th>RCA 2</th>
                        <th>RCA 3</th>
                        <th>Comments Section</th>

                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </div>
</div>




<div class="card shadow mb-4" id="Predictivediv" style="display:none">
    <div class="card-header">
        <strong class="card-title">Predictive Analysis</strong>
       
    </div>
    <div class="card-body">
        <div class="row">
            <table id="predictiveAnalysisTable" class="table table-bordered">
                <thead>
                    <tr>
                       
                        <th>Predictive - CSAT</th>
                        <th>Predictive - NPS</th>
                        <th>Predictive - FCR</th>
                        <th>Predictive - Repeat</th>
                        <th>Predictive - Sales effort</th>
                        <th>Predictive - Collection effort</th>
                        <th>Predictive - Probable escalation</th>
                       
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </div>
</div>



<div class="card shadow mb-4" id="ZtClassfictions" style="display:none">
    <div class="card-header">
        <strong class="card-title">ZT Classification</strong>
      
    </div>
    <div class="card-body">
        <div class="row col-md-4">
            <label for="ZTClassification">Select  ZT Classification</label>
            <select id="ZTClassification" class="custom-select">
              
            </select>

        </div>
    </div>
</div>


<div class="card shadow mb-4" id="Zerotollernce" style="display:none">
    <div class="card-header">
        <strong class="card-title">Zero Tolerance Behaviour</strong>
    </div>
    <div class="card-body">
        <div class="row">
            <label><strong>Was there any Zero Tolerance Behaviour identified?</strong></label>
            <div class="form-check form-check-inline" style="margin-left: 75px;">
                <input class="form-check-input" type="checkbox" id="yesCheckbox" name="zeroTolerance" value="Yes">
                <label class="form-check-label" for="yesCheckbox">Yes</label>
            </div>
            <div class="form-check form-check-inline" style="margin-left: 75px;">
                <input class="form-check-input" type="checkbox" id="noCheckbox" name="zeroTolerance" value="No">
                <label class="form-check-label" for="noCheckbox">No</label>
            </div>

        </div>
    </div>
</div>


<div class="card shadow mb-4">
    <div class="card-header">
    </div>
    <div class="card-body">
        <div class="row">

            <div class="col-md-2">
                <div class="form-group mb-3">
                    <button id="btnSubmite" class="btn btn-primary mt-4" onclick="SubMitedata()">Submit</button>
                </div>
            </div>
         

            <div class="col-md-2">
                <div class="form-group mb-3">
                    <button id="btnLogZT" class="btn btn-primary mt-4" >Log ZT</button>
                </div>

            </div>
            <div class="col-md-2">
                <div class="form-group mb-3">
                    <button id="btnClearForm" class="btn btn-primary mt-4">Clear Form</button>
                </div>

            </div>
            <div class="col-md-2">
                <div class="form-group mb-3">
                    <button id="btnVoicefeed" class="btn btn-primary mt-4">Record voice Feedback</button>
                </div>

            </div>
        </div>
    </div>
</div>
<script>

    function InsertCallAudit() {
        console.log("Button Clicked!");
        var selectedZTClassification = $("#ZTClassification").val();
        var zeroToleranceValue = $("input[name='zeroTolerance']:checked").val();
        var CcID = $("#Transaction_ID").val();
        var totalScoreValue = $("#totalScore").text().trim();

        if (!selectedZTClassification ) {
            alert("Please  selected ZTC lassification  .");
            return false;
        }
        if (!zeroToleranceValue ) {
            alert("Please  selected  zero ToleranceValue .");
            return false;
        }
        if (!CcID) {
            alert("Please Select Call For  Audit  .");
            return false;
        }

        return {
            AuditID: $("#AuditID").val(),
            ProgramID: $("#ProgramID").val(),
            SUBProgramID: $("#SUBProgramID").val(),
            dispositionId: $("#dispositionId").val(),
            SubDispositionID: $("#SubDispositionID").val(),
            FromDate: $("#FromDate").val(),
            ToDate: $("#Todate").val(),
            AgentID: $("#AgentID").val(),
            TL_id: $("#TL_id").val(),
            Transaction_ID: CcID,
            Monitored_date: $("#Monitored_date").val(),
            Transaction_Date: $("#Transaction_Date").val(),
            Year: $("#Year").val(),
            Month: $("#Month").val(),
            Week: $("#Week").val(),
            ZTClassification: selectedZTClassification,
            ZeroTolerance: zeroToleranceValue,
            CQ_Scrore: totalScoreValue
        };
    }

    function InsertSectionAudit() {
        
         var isValid = true;
            var gridData = [];


                $("#sectionGrid tbody tr:not(:last-child)").each(function () {
                    var $row = $(this);
                    var category = $row.find("td:eq(0)").text()?.trim() || "";
                    var level = $row.find("td:eq(1)").text()?.trim() || "";
                    var sectionName = $row.find("td:eq(2)").text()?.trim() || "";
                    var qaRating = $row.find(".qa-rating").val();
                    var scorable = $row.find("td:eq(4)").text()?.trim() || "";
                    var score = $row.find("td:eq(5)").text()?.trim() || "";
                   var comments = $row.find("input[type='text']").val()?.trim() || "";

                    if (category === "" && level === "" && sectionName === "") {
                        return;
                    }
                    if (qaRating === "") {
                        isValid = false;
                        $row.find(".qa-rating").addClass("border border-danger");
                      
                    } else {
                        $row.find(".qa-rating").removeClass("border border-danger");
                       
                    }

                     if ( comments === "") {
                        isValid = false;
                       
                         $row.find("input[type='text']").addClass("border border-danger");
                    } else {
                        
                         $row.find("input[type='text']").removeClass("border border-danger");
                    }

                    gridData.push({
                        category: category,
                        level: level,
                        sectionName: sectionName,
                        qaRating: qaRating,
                        scorable: scorable,
                        score: score,
                        comments: comments,
                        Transaction_ID: $("#Transaction_ID").val(),
                        ProgramID: $("#ProgramID").val(),
                        SUBProgramID: $("#SUBProgramID").val()
                    });
                });


            if (!isValid) {
                alert("Please select QA Rating and enter Comments In Section ");
                return;
            }


        return isValid ? gridData : false;
    }

    function RootCauseEvaluation() {
          let tableData = [];
        let isValid = true;

        $("#rootCauseTable tbody tr").each(function () {
            let row = $(this);
            let metricRCA = row.find("td:eq(0)").text().trim();
            let controllable = row.find(".qa-rating[data-index]").val();
            let rca1 = row.find(".rca1").val();
            let rca2 = row.find(".rca2").val();
            let rca3 = row.find(".rca3").val();
            let comments = row.find("input[type='text']").val().trim();


             let fields = [
                { element: row.find(".qa-rating[data-index]"), value: controllable },
                { element: row.find(".rca1"), value: rca1 },
                { element: row.find(".rca2"), value: rca2 },
                { element: row.find(".rca3"), value: rca3 },
                { element: row.find("input[type='text']"), value: comments }
            ];

            fields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.element.addClass("border border-danger");
                } else {
                    field.element.removeClass("border border-danger");
                }
            });

            tableData.push({
                metricRCA: metricRCA,
                controllable: controllable,
                rca1: rca1,
                rca2: rca2,
                rca3: rca3,
                comments: comments,
                Transaction_ID: $("#Transaction_ID").val(),
                ProgramID: $("#ProgramID").val(),
                SUBProgramID: $("#SUBProgramID").val()
            });
        });

        if (!isValid) {
            alert("Please fill all fields  in Root Cause Evaluation before submitting.");
            return;
        }
        return isValid ? tableData : false;
    }

    function InsertPredictiveEvaluation() {
          let tableId = "#predictiveAnalysisTable";
        let tableBody = $(tableId + " tbody");
        let dataToSend = [];
        let isValid = true;
        let transactionId = $("#Transaction_ID").val();
        let programId = $("#ProgramID").val();
        let subProgramId = $("#SUBProgramID").val();

        tableBody.find("tr").each(function () {
            let row = $(this);
            let rowData = {
                Transaction_ID: transactionId,
                ProgramID: programId,
                SUBProgramID: subProgramId
            };

            rowData["PredictiveCSAT"] = row.find("td:eq(0)").text().trim();
            row.find("select").each(function (index) {
                let dropdown = $(this);
                let selectedValue = dropdown.val();

                if (!selectedValue) {
                    isValid = false;
                    dropdown.addClass("is-invalid");
                } else {
                    dropdown.removeClass("is-invalid");
                }

                let columnNames = [
                    "PredictiveNPS",
                    "PredictiveFCR",
                    "PredictiveRepeat",
                    "PredictiveSalesEffort",
                    "PredictiveCollectionEffort",
                    "PredictiveEscalation"
                ];
                rowData[columnNames[index]] = selectedValue;
            });

            dataToSend.push(rowData);
        });


        if (!isValid) {
            alert("Please select all dropdown values in Predictive Evaluation before submitting.");
            return;
        }
        return isValid ? dataToSend : false;
    }

        function clearValues() {
        $("#sectionGrid tbody").find("tr").each(function () {
            $(this).find(".qa-rating").val(""); 
            
            $(this).find("#Comments_Section").val("");
        });
             $("#rootCauseTable tbody, #predictiveAnalysisTable tbody").find("tr").each(function () {
            $(this).find("select").val(""); 
            $(this).find("input[type='text']").val("");
        });

          $("#ZTClassification").val("");
        $("#yesCheckbox, #noCheckbox").prop("checked", false);

           let container = document.getElementById("recordingContainer");
            container.innerHTML = ""; 
            container.style.display = "none";

             $("#SectionGried").hide();
           $("#rooutcause").hide();
             $("#Predictivediv").hide();
             $("#ZtClassfictions").hide();
             $("#Zerotollernce").hide();
       
    }

    function SubMitedata() {
         let pauseIcon = document.getElementById("pauseIcon");

                if (pauseIcon.classList.contains("fe-pause")) {
                    alert("Please resume before  Submite the audit.");
                    return;
                }
       
         var CcID = $("#Transaction_ID").val();
         if (!CcID) {
            alert("Please Select Call For  Audit First .");
            return false;
        }
        var AuditType=$("#AuditID").val();
        if(AuditType==2)
        {
            var dispositionId=  $("#dispositionId").val();
           var  SubDispositionID = $("#SubDispositionID").val();
            if (!dispositionId || !SubDispositionID ) {
            alert("Please select Disposition And SubDisposition before submitting.");
            return;
        }
        }
        let callAuditData = InsertCallAudit();
        let sectionAuditData = InsertSectionAudit();
        let rootCauseData = RootCauseEvaluation();
        let predictiveData = InsertPredictiveEvaluation();

        console.log("Call Audiut");

        console.log(JSON.stringify(callAuditData));
          console.log("Section");
        console.log(JSON.stringify(sectionAuditData));
          console.log("Roout Cause");
        console.log(JSON.stringify(rootCauseData));
          console.log("Pridictive");
        console.log(JSON.stringify(predictiveData));




        if (!callAuditData || !sectionAuditData || !rootCauseData || !predictiveData) {
            alert("Please fill all required fields before submitting.");
            return;
        }
         endAudit();
        $.ajax({
            url: "/Monitor/FormMinitoringAuditr",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(callAuditData),
            success: function () { }
        });

        $.ajax({
            url: "/Monitor/InsertSectionAudit",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(sectionAuditData),
            success: function () {  }
        });

       $.ajax({
         url: "/Monitor/InsertRouutCoauseAudit",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(rootCauseData),
            success: function (response) {
                
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
               
            }
        });

          $.ajax({
            type: "POST",
                url: "/Monitor/InsertPridictiveCoauseAudit",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(predictiveData),
            dataType: "json",
            success: function (response) {
                if (response.success) {
                    alert("Call Evaluation  submitted successfully!");
                    clearValues();
                  
                } else {
                    alert("Failed to submit  Evaluation data.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error occurred: " + error);
                alert("An error occurred while submitting data.");
            }
        });
    }
</script>


<script>
      function getWeekNumber(date) {
        var firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        var dayOfMonth = date.getDate();
        var weekNumber = Math.ceil((dayOfMonth + firstDayOfMonth.getDay()) / 7);
        return weekNumber;
    }
    document.addEventListener("DOMContentLoaded", function () {
         var today = new Date();

   
        var formattedDate = today.toISOString().split('T')[0];

       
        document.getElementById("Monitored_date").value = formattedDate;
        document.getElementById("Transaction_Date").value = formattedDate;
        

         var year = today.getFullYear();
        var month = today.toLocaleString('default', { month: 'long' }); 
        var weekNumber = getWeekNumber(today);
             document.getElementById("Year").value = year;
          document.getElementById("Month").value = month;
          document.getElementById("Week").value = weekNumber;


            function configureDatePicker(id) {
                const dateInput = document.getElementById(id);

                dateInput.max = new Date().toISOString().split("T")[0]; // Prevent future dates

                dateInput.addEventListener("change", function () {
                    validateDate(id);
                });
            }

            function validateDate(id) {
                let selectedDate = new Date(document.getElementById(id).value);
                let currentDate = new Date();
                let minAllowedDate = new Date(currentDate.getTime() - (48 * 60 * 60 * 1000)); // 48 hours ago

                if (selectedDate > currentDate) {
                    alert("Selected date cannot be in the future.");
                    document.getElementById(id).value = "";
                } else if (selectedDate < minAllowedDate) {
                    alert("Selected date must be within the last 48 hours.");
                    document.getElementById(id).value = "";
                }
            }

            configureDatePicker("FromDate");
            configureDatePicker("ToDate");
        });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const yesCheckbox = document.getElementById("yesCheckbox");
        const noCheckbox = document.getElementById("noCheckbox");

        yesCheckbox.addEventListener("change", function () {
            if (this.checked) {
                noCheckbox.checked = false;
            }
        });

        noCheckbox.addEventListener("change", function () {
            if (this.checked) {
                yesCheckbox.checked = false;
            }
        });
    });
</script>
<script>


    document.addEventListener("click", function (event) {
        let target = event.target;
        if (target.classList.contains("play-audio")) {
            document.querySelectorAll(".play-audio").forEach(el => el.style.color = "gray");
            target.style.color = "#03FD03";
            target.style.setProperty("color", "#03FD03", "important");

            var audioPath = target.getAttribute("data-path");

                              $.ajax({
                        type: "POST",
                        url: "/Monitor/CheckTheAuditIsDone",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({ id: audioPath }),
                        success: function (response) {
                            if (response.success) {
                                if (response.connid && response.connid.trim() !== "") {
                                    alert("For This Transaction ID, Audit Has Been Done");
                                    return;
                                }
                                else{
                                      $("#Transaction_ID").val(audioPath);
                                        $.ajax({
                                            type: "POST",
                                            data: JSON.stringify({ id: audioPath }),
                                            url: "/Monitor/GetRecording",
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            success: function (response) {
                                                if (response.success) {
                                                    let container = document.getElementById("recordingContainer");
                                                    container.innerHTML = "";
                                                    let byteCharacters = atob(response.audioData);
                                                    let byteNumbers = new Array(byteCharacters.length);
                                                    for (let i = 0; i < byteCharacters.length; i++) {
                                                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                                                    }
                                                    let byteArray = new Uint8Array(byteNumbers);
                                                    let blob = new Blob([byteArray], { type: "audio/mpeg" });
                                                    let audioUrl = URL.createObjectURL(blob);

                                                    let audioPlayer = document.createElement("audio");
                                                    audioPlayer.controls = true;
                                                    audioPlayer.src = audioUrl;
                                                    audioPlayer.autoplay = true;
                                                    audioPlayer.style.width = "100%";
                                                    container.appendChild(audioPlayer);
                                                    container.style.display = "block";
                                                } else {
                                                    console.error("Error: " + response.message);
                                                }
                                            },
                                            error: function (xhr, status, error) {
                                                console.error("Error occurred: " + error);
                                            }
                                        });
                                }
                            } else {
                                console.error("Error: " + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error occurred: " + error);
                        }
                    });




          
        }
    });



</script>

<script>
    let timerInterval, startTime, pauseTime, resumeTime, endTime;
    let elapsedSeconds = 0, pauseCount = 0, pauseLimit=0, totalPauseDuration = 0;
    let auditLogs = [];


    function updateTimerDisplay() {
        let minutes = Math.floor(elapsedSeconds / 60);
        let seconds = elapsedSeconds % 60;
        document.getElementById("timer").innerText =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function startAudit() {
        DisplayDiv();
           



         var selectedValue = document.getElementById("SUBProgramID").value;
         $.ajax({
             type: "POST",
             url: "/Monitor/GetPauseLimit",
             contentType: "application/json; charset=utf-8",
             dataType: "json",
             data: JSON.stringify({ SUBProcessID: selectedValue, ProcessID: $('#ProgramID').val() }),
             success: function (response) {
                 
                      pauseLimit = response.pauselimit;
                       document.getElementById("pauseLimit").innerText = `Limit Of Pauses: ${pauseLimit}`;

             },
             error: function (xhr, status, error) {
                 console.error("Error occurred: " + error);
             }
         });
         
      
        startTime = new Date();
        document.getElementById("pauseButton").disabled = false;
     
        document.getElementById("StartAudit").disabled = true;

        auditLogs.push({ type: "Start", time: startTime });

        timerInterval = setInterval(() => {
            elapsedSeconds++;
            updateTimerDisplay();
        }, 1000);
    }

    function togglePause() {
        let pauseButton = document.getElementById("pauseButton");
        let pauseIcon = document.getElementById("pauseIcon");

        if (timerInterval) {
               if (pauseCount >= pauseLimit)
               {
                   alert("Now You Can Not Take a pause Because You Have Reached the Pause Limit: " + pauseLimit);
                   return;
               }
            clearInterval(timerInterval);
            timerInterval = null;
            pauseTime = new Date();
            pauseCount++;
            pauseIcon.classList.replace("fe-play", "fe-pause");

            auditLogs.push({ type: "Pause", time: pauseTime });

            document.getElementById("pauseCount").innerText = `Pauses: ${pauseCount}`;
        } else {
            // Resuming

             
            resumeTime = new Date();
            let pauseDuration = (resumeTime - pauseTime) / 1000;
            totalPauseDuration += pauseDuration;

            auditLogs.push({ type: "Resume", time: resumeTime, pauseDuration });

            timerInterval = setInterval(() => {
                elapsedSeconds++;
                updateTimerDisplay();
            }, 1000);

            pauseIcon.classList.replace("fe-pause", "fe-play");
        }
    }

    function endAudit() {
        clearInterval(timerInterval);
        timerInterval = null;
        endTime = new Date();

        auditLogs.push({ type: "End", time: endTime });

        // Prepare Data for AJAX
        let auditData = {
            startTime: startTime,
            endTime: endTime,
            totalDuration: elapsedSeconds,
            totalPauseCount: pauseCount,
            totalPauseDuration: totalPauseDuration,
            logs: auditLogs,
             Transaction_ID: $("#Transaction_ID").val(),
                ProgramID: $("#ProgramID").val(),
                SUBProgramID: $("#SUBProgramID").val()

        };

        console.log("Audit Data Sent:", auditData); // Debugging
    fetch('/save-audit', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify(auditData)
       })
       .then(response => response.json())
       .then(data => {
           console.log("Server Response:", data);
           alert("Audit Saved Successfully!");
       })
       .catch(error => console.error("Error:", error))
        // Reset UI
        document.getElementById("StartAudit").disabled = false;
        document.getElementById("pauseButton").disabled = true;
   
        document.getElementById("pauseCount").innerText = "Pauses: 0";
        elapsedSeconds = 0;
        pauseCount = 0;
        totalPauseDuration = 0;
        auditLogs = [];
        updateTimerDisplay();
    }
</script>
<script>

     

     function DisplayDiv()
     {
       
         $("#SectionGried").show();
           $("#rooutcause").show();
             $("#Predictivediv").show();
             $("#ZtClassfictions").show();
             $("#Zerotollernce").show();
     }
    function OnAuditChange()
    {
        var audit = $("#AuditID").val();
        if(audit==2)
        {
           $("#DispoID").show();
              $("#SUBDispoID").show();
           
        }
        else{
            $("#DispoID").hide();
            $("#SUBDispoID").hide();
        }
   

    }
        function clearFields() {
        $("#SUBProgramID").empty().append('<option value="">Select Sub Program</option>');
        $("#dispositionId").empty().append('<option value="">Select Disposition</option>');
        $("#SubDispositionID").empty().append('<option value="">Select Sub Disposition</option>');
        $("#AgentID").empty().append('<option value="">Select Agent</option>');
        $("#TL_id").val("");
        $("#RelListDiv").hide();
            $("#LastReansaction").hide();
    }

        function clearFieldsSubProcesssChange() {

        $("#dispositionId").empty().append('<option value="">Select Disposition</option>');
        $("#SubDispositionID").empty().append('<option value="">Select Sub Disposition</option>');
        $("#AgentID").empty().append('<option value="">Select Agent</option>');
        $("#TL_id").val("");
        $("#RelListDiv").hide();
            $("#LastReansaction").hide();
    }
    function onProgramChange() {
           var programId = document.getElementById("ProgramID").value;


           if (programId == "") {
               alert("Please Select Program first");
               return;
           }
           $.ajax({
               type: "POST",
               data: JSON.stringify({ id: programId }),

               url: "/Admin/GetSUBProcessList",
               contentType: "application/json; charset=utf-8",
               dataType: "json",
               success: function (response) {

                   var dropdown = $('#SUBProgramID');
                   dropdown.empty();
                   dropdown.append('<option value="">Select Sub Process</option>');
                   response.proces.forEach(function (item) {
                       dropdown.append('<option value="' + item.value + '">' + item.text.split(',')[0] + '</option>');
                   });
               },
               error: function (xhr, status, error) {
                   console.error("Error occurred: " + error);
               }
           });


           clearFields();

       }


        function onAgentIDChange() {

             var fromDate = $("#FromDate").val();
                var toDate = $("#Todate").val();
                var agentId = $("#AgentID").val();


                      if (!fromDate || !toDate ) {
                                $("#FromDate").val(""); // Clear the value
                                $("#Todate").val("");   // Clear the value
                                alert("Invalid date selection. Dates have been cleared.");
                            }
                if (!agentId) {
                    alert("Please select an Agent.");
                    return;
                }
           var programId = document.getElementById("AgentID").value;


           if (programId == "") {
               alert("Please Select Agent first");
               return;
           }
           $.ajax({
               type: "POST",
               data: JSON.stringify({ id: programId }),

               url: "/Monitor/GetTLName",
               contentType: "application/json; charset=utf-8",
               dataType: "json",
               success: function (response) {
                if (response.success) {
                    $("#TL_id").val(response.tl_name);  // Corrected this line
                } else {
                    alert("Error fetching TL Name.");
                    $("#RelListDiv").hide();
                }
               },
               error: function (xhr, status, error) {
                   console.error("Error occurred: " + error);
               }
           });
           
           $("#RelListDiv").show();
             $("#LastReansaction").show();
           $.ajax({
                    type: "POST",
                    data: JSON.stringify({ fromDate: fromDate, toDate: toDate, agentId: agentId }),
                    url: "/Monitor/GetRecListBydate",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {

                             let recList = JSON.parse(response.reclist);


                              var tableBody = document.getElementById("recTableBody");

                                recList.forEach(function (rec) {
                                    var row = `<tr>
                                        <td class="text-center">
                                            <div >
                                             <span class="fe fe-24 fe-headphones play-audio" style="color: gray;" data-path="${rec.CONNID}"></span>

                                            </div>

                                        </td>
                                        <td class="text-muted">${rec.AgentId}</td>
                                         <td class="text-muted">${rec.CONNID}</td>

                                        <td class="text-muted">${rec.CallDuration}</td>
                                    </tr>`;

                                    tableBody.innerHTML += row;
                                });
                        } else {
                            alert("Error processing date range.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error occurred: " + error);
                    }
                });
                GetSectionGried();

       }
        function populateGrid(data) {
        var tableBody = $("#sectionGrid tbody");
        tableBody.empty();
        if (data.length === 0) {
            tableBody.append("<tr><td colspan='10' class='text-center'>No records found</td></tr>");
            return;
        }

                    $.each(data, function (index, item) {
                        var row = `<tr>
                        <td>${item.category}</td>
                        <td>${item.level}</td>
                        <td>${item.sectionName}</td>
                        <td>
                            <select class="qa-rating form-control" data-index="${index}">
                             <option value="">Select Rating</option>
                                <option value="Met">Met</option>
                                <option value="Not Met">Not Met</option>
                            </select>
                        </td>
                        <td>${item.scorable}</td>
                        <td class="score-col">${item.score}</td>
                          <td><input type="text" class="form-control" id="Comments_Section" placeholder="Enter Comments Section"></td>
                    </tr>`;

                        tableBody.append(row);
                    });
                       var footerRow = `<tr>
        <td colspan="5" class="text-right font-weight-bold">CQ Scores:</td>
        <td id="totalScore" class="font-weight-bold">0</td>
    </tr>`;

    tableBody.append(footerRow);

         $(".qa-rating").on("change", function () {
        var selectedValue = $(this).val();
        var rowIndex = $(this).data("index");
        var scoreCell = $(this).closest("tr").find(".score-col");

        if (selectedValue === "Met") {
            scoreCell.text(data[rowIndex].score);
        } else {
            scoreCell.text(0);
        }
        calculateTotalScore();
    });
    calculateTotalScore();
    }

     function calculateTotalScore() {
     
        let total = 0;
        $("#sectionGrid tbody tr").each(function () {
            var scorable = $(this).find("td:nth-child(5)").text().trim(); // 5th column (scorable)
            var score = parseInt($(this).find(".score-col").text()) || 0;

            if (scorable === "Yes") {
                total += score;
            }
        });
        $("#totalScore").text(total);
    }

       function GetSectionGried()
       {
           var selectedValue = document.getElementById("SUBProgramID").value;
            $.ajax({
                type: "POST",
                url: "/ManageForm/GetSectionGried",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ SUBProcessID: selectedValue, ProcessID: $('#ProgramID').val() }),
                success: function (response) {
                  console.log(JSON.stringify(response));
                    populateGrid(response.sectionGrid);

                            if (response?.filteredPredictiveList?.length > 0) {
                                 populateTable("#predictiveAnalysisTable", response.filteredPredictiveList, "Predictive");
                            } else {
                                console.error("filteredPredictiveList is empty.");
                            }


                            if (response?.filteredZTClassificationList?.length > 0) {
                                // populateTable("#ztClassificationTable", response.filteredZTClassificationList, "ZTClassification");
                                  const dropdown = document.getElementById("ZTClassification");

                                    dropdown.innerHTML = '<option value="">Select  ZT Classification</option>';

                                     response.filteredZTClassificationList.forEach(item => {
                                        let option = document.createElement("option");
                                        option.value = item.value;
                                        option.textContent = item.text;
                                        dropdown.appendChild(option);
                                    });

                            } else {
                                console.error("filteredZTClassificationList is empty.");
                            }

                              if (response?.filteredRoutwCauseList?.length > 0) {
                                populateTable("#rootCauseTable", response.filteredRoutwCauseList, "RootCause");
                            } else {
                                console.error("filteredRoutwCauseList is empty.");
                            }
                },
                error: function (xhr, status, error) {
                    console.error("Error occurred: " + error);
                }
            });
       }
    function onSubProgramChange() {

        var selectedValue = document.getElementById("SUBProgramID").value;

        if (selectedValue === '') {
            alert('Please select a valid Sub Program Name.');
         return;
        } else {
            console.log("Selected Sub Program ID:", selectedValue);


            $.ajax({
                type: "POST",
                url: "/Monitor/GetDispositoin",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ SUBProcessID: selectedValue, ProcessID: $('#ProgramID').val() }),
                success: function (response) {
                  var dropdown = $('#dispositionId');
                    dropdown.empty();
                    dropdown.append('<option value="">Select Disposition</option>');

                    console.log(JSON.stringify(response)); // Debugging

                    // Ensure we use the correct response property
                    if (response.success && response.samplesize) {
                        response.samplesize.forEach(function (item) {
                            dropdown.append('<option value="' + item.value + '">' + item.text + '</option>');
                        });
                     }


                      var dropdown = $('#AgentID');
                    dropdown.empty();
                    dropdown.append('<option value="">Select Agent Name</option>');

                    console.log(JSON.stringify(response)); // Debugging

                    // Ensure we use the correct response property
                    if (response.success && response.agentlist) {
                        response.agentlist.forEach(function (item) {
                            dropdown.append('<option value="' + item.value + '">' + item.text + '</option>');
                        });
                     }
                },
                error: function (xhr, status, error) {
                    console.error("Error occurred: " + error);
                }
            });
        }
        clearFieldsSubProcesssChange();
    }



    function onDispositionChange() {

        var selectedValue = document.getElementById("SUBProgramID").value;
        var Disposition = document.getElementById("dispositionId").value;

        if (Disposition === '') {
            alert('Please select a valid Disposition Name.');
      return;
        } else {
            console.log("Selected Sub Program ID:", selectedValue);


            $.ajax({
                type: "POST",
                url: "/Monitor/GetSubDispositoin",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ SUBProcessID: selectedValue, ProcessID: $('#ProgramID').val()  ,Disposition:Disposition}),
                success: function (response) {
                  var dropdown = $('#SubDispositionID');
                    dropdown.empty();
                    dropdown.append('<option value="">Select Sub Disposition</option>');

                    console.log(JSON.stringify(response));
                    if (response.success && response.samplesize) {
                        response.samplesize.forEach(function (item) {
                            dropdown.append('<option value="' + item.value + '">' + item.text + '</option>');
                        });
                     }
                },
                error: function (xhr, status, error) {
                    console.error("Error occurred: " + error);
                }
            });
        }
    }



        function populateTable(tableId, data, type) {
        let tableBody = $(tableId + " tbody");
        tableBody.empty();

        // Fetch RCA values once and then populate table
        $.ajax({
            type: "GET",
            url: "/Monitor/GetRCAValues",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) {
                    console.error("Failed to fetch RCA values.");
                    return;
                }

                console.log("Rec List");

                console.log(JSON.stringify(response));
                let rca1Options = generateDropdownOptions(response.rca1);
                let rca2Options = generateDropdownOptions(response.rca2);
                let rca3Options = generateDropdownOptions(response.rca3);

                data.forEach((item, index) => {
                    let extraColumns = "";

                    if (type === "RootCause") {
                        extraColumns = `
                            <td>
                                <select class="qa-rating form-control" data-index="${index}">
                                    <option value="">Select Controllable</option>
                                    <option value="Yes" ${item.controllable === "Yes" ? "selected" : ""}>Yes</option>
                                    <option value="No" ${item.controllable === "No" ? "selected" : ""}>No</option>
                                </select>
                            </td>
                            <td>
                                <select class="qa-rating form-control rca1" data-index="${index}">
                                    <option value="">Select RCA 1</option>
                                    ${generateDropdownOptions(response.rca1, item.rca1)}
                                </select>
                            </td>
                            <td>
                                <select class="qa-rating form-control rca2" data-index="${index}">
                                    <option value="">Select RCA 2</option>
                                    ${generateDropdownOptions(response.rca2, item.rca2)}
                                </select>
                            </td>
                            <td>
                                <select class="qa-rating form-control rca3" data-index="${index}">
                                    <option value="">Select RCA 3</option>
                                    ${generateDropdownOptions(response.rca3, item.rca3)}
                                </select>
                            </td>
                            <td>
                                <input type="text" class="form-control" placeholder="Enter value" value="${item.textValue || ''}" />
                            </td>`;
                    }
                        else if (type === "Predictive") {
                                        extraColumns = `
                                        <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select NPS</option>
                                                <option value="Positive">Positive</option>
                                                <option value="Neutral">Neutral</option> <!-- Fixed spelling -->
                                                <option value="Negative">Negative</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select FCR</option>
                                                <option value="YES">YES</option>
                                                <option value="NO">NO</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select Repeat</option>
                                                <option value="YES">YES</option>
                                                <option value="NO">NO</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select Sales effort</option>
                                                <option value="YES">YES</option>
                                                <option value="NO">NO</option>
                                            </select>
                                        </td>
                                         <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select Collection effort</option>
                                                <option value="YES">YES</option>
                                                <option value="NO">NO</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="qa-rating form-control" data-index="${index}">
                                                <option value="">Select Escalation</option>
                                                <option value="YES">YES</option>
                                                <option value="NO">NO</option>
                                            </select>
                                        </td>`;
                                    }

                    let row = `<tr>
                       
                        <td>${item.text}</td>
                        ${extraColumns}
                    </tr>`;
                    tableBody.append(row);
                });
            },
            error: function (xhr, status, error) {
                console.error("Error occurred: " + error);
            }
        });
    }

    function generateDropdownOptions(data, selectedValue = "") {
        return data.map(item => `
            <option value="${item.id}" ${item.id == selectedValue ? "selected" : ""}>
                ${item.rcA_Value}
            </option>`).join("");
    }



</script>