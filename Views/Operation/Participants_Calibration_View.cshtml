@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="card shadow mb-4" id="SectionGried" style="display:none">
    <div class="card-header">
        <strong class="card-title"> Section</strong>
    </div>
    <div class="card-body">
        <table id="sectionGrid" class="table table-bordered">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Level</th>
                    <th>Section Name</th>
                    <th>QA Rating</th>
                    <th>Scorable</th>
                    <th>Weightage</th>
                    <th>Comments Section</th>
                    <th>Fatal</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<div class="col-md-12" >

    <div id="recordingContainer"></div>

</div>


<div class="card shadow mb-4" id="MasterCalibrator" style="display:none">
    <div class="card-header">
        <strong class="card-title"></strong>

    </div>
    <div class="card-body">

        <div class="row">
            <div class="form-group col-md-6">
                <label for="ProgramID"> Calibrator Comments</label> <span style="color:red">*</span>
                <input type="text" id="Master_Comments" class="form-control" />
            </div>

        </div>
        <div class="row">
            <div class="form-group col-md-6">
                <button onclick="SubMiteSection()" class="btn btn-primary" id="calibration"> Calibrate</button>
            </div>

        </div>

    </div>


</div>
<script src="~/js/jquery.min.js"></script>
<script>
     var transactionId = '@ViewBag.TransactionID';
            var process = '@ViewBag.Process';
            var subProcess = '@ViewBag.subProcess';

     $(document).ready(function () {
        var transactionId = '@ViewBag.TransactionID';
        var process = '@ViewBag.Process';
        var subProcess = '@ViewBag.subProcess';

        GetSectionGrid(process, subProcess);

         $.ajax({
            type: "POST",
            data: JSON.stringify({ id: '@ViewBag.TransactionID' }),
            url: "/Monitor/GetRecording",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) return;

                let container = document.getElementById("recordingContainer");
                container.innerHTML = "";

                container.style.cssText = `
                    background-image: url('/images/image.png');
                background-size: 100% 185%; /* Stretches fully */
                background-repeat: no-repeat;
                background-position: center;
                width: 100%;
                height: 300px; /* You can adjust this height */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
                position: relative;
                `;

                if (!response.audioData) {
                    console.error("No audio data received.");
                    return;
                }

                try {
                    let byteCharacters = atob(response.audioData);
                    let byteNumbers = new Uint8Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }

                    let blob = new Blob([byteNumbers], { type: "audio/mpeg" });
                    let audioUrl = URL.createObjectURL(blob);

                    let audioPlayer = document.createElement("audio");
                    audioPlayer.controls = true;
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.cssText = `
                         width: 100%;
                    max-width: 643px;
                    margin-top: 197px;
                    `;
                    container.appendChild(audioPlayer);
                    audioPlayer.play().catch(console.error);
                } catch (e) {
                    console.error("Invalid Base64 audio data:", e);
                }
            },
            error: function (xhr, status, error) {
                console.error("Error occurred: " + error);
            }
        });
    }); 





         function InsertSectionAudit() {

             var isValid = true;
                var gridData = [];


                    $("#sectionGrid tbody tr:not(:last-child)").each(function () {
                        var $row = $(this);
                        var category = $row.find("td:eq(0)").text()?.trim() || "";
                        var level = $row.find("td:eq(1)").text()?.trim() || "";
                        var sectionName = $row.find("td:eq(2)").text()?.trim() || "";
                        var qaRating = $row.find(".qa-rating").val();
                        var scorable = $row.find("td:eq(4)").text()?.trim() || "";
                        var score = $row.find("td:eq(5)").text()?.trim() || "";
                       var comments = $row.find("input[type='text']").val()?.trim() || "";
                        var fatal = $row.find(".fatal-select").val()?.trim() || "";

                        if (category === "" && level === "" && sectionName === "") {
                            return;
                        }
                        if (qaRating === "") {
                            isValid = false;
                            $row.find(".qa-rating").addClass("border border-danger");

                        } else {
                            $row.find(".qa-rating").removeClass("border border-danger");

                        }
                         if (fatal === "") {
                            isValid = false;
                             return;
                            $row.find(".fatal-select").addClass("border border-danger");

                        } else {
                            $row.find(".fatal-select").removeClass("border border-danger");

                        }

                         if ( comments === "") {
                            

                             $row.find("input[type='text']").addClass("border border-danger");
                        } else {

                             $row.find("input[type='text']").removeClass("border border-danger");
                        }
                             var CalibratedComment = document.getElementById("Master_Comments").value;

                      if ( !CalibratedComment) {

                        alert("Please fill all the required CalibratedComment  fields");
                       isValid = false;
                        return;
                    }
                        gridData.push({
                            category: category,
                            level: level,
                            sectionName: sectionName,
                            qaRating: qaRating,
                            scorable: scorable,
                            score: score,
                            comments: comments,
                            Transaction_ID: transactionId,
                            ProgramID:process,
                            SUBProgramID: subProcess,
                            fatal:fatal,
                            Comment:CalibratedComment
                        });
                    });


                if (!isValid) {
                    alert("Please select All Feilds ");
                    return;
                }


            return isValid ? gridData : false;
        }
        function SubMiteSection()
        {
             let sectionAuditData = InsertSectionAudit();
               console.log(JSON.stringify(sectionAuditData));
               
                     
                  
                       

              $.ajax({
                url: "/Operation/InsertSectionAudit",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(sectionAuditData),
                success: function (
                ) {  alert("Submit Calibration");
        window.location.href = "/Operation/Dashboard";
                }
            });
            
        }

      
            function populateGrid(data, ratingList) {
            var tableBody = $("#sectionGrid tbody");
            tableBody.empty();

            if (data.length === 0) {
                tableBody.append("<tr><td colspan='10' class='text-center'>No records found</td></tr>");
                return;
            }

            $.each(data, function (index, item) {
                var ratingOptions = `<option value="">Select Rating</option>`;
                $.each(ratingList, function (_, rating) {
                    ratingOptions += `<option value="${rating.text}">${rating.text}</option>`;
                });

                var row = `<tr>
                    <td>${item.category}</td>
                    <td>${item.level}</td>
                    <td>${item.sectionName}</td>
                    <td>
                        <select class="qa-rating form-control" data-index="${index}">
                            ${ratingOptions}
                        </select>
                    </td>
                    <td>${item.scorable}</td>
                    <td class="score-col">${item.score}</td>
                    <td><input type="text" class="form-control" id="Comments_Section" placeholder="Enter Comments Section"></td>
                    <td>
                        <select class="fatal-select form-control" data-index="${index}">
                            <option value="">Select Fatal</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </td>
                </tr>`;

                tableBody.append(row);
            });

            var footerRow = `<tr>
                <td colspan="5" class="text-right font-weight-bold">CQ Scores:</td>
                <td id="totalScore" class="font-weight-bold">0</td>
            </tr>`;
            tableBody.append(footerRow);

            $(".fatal-select").on("change", function () {
                calculateTotalScore();
            });

            $(".qa-rating").on("change", function () {
                var selectedValue = $(this).val();
                var rowIndex = $(this).data("index");
                var scoreCell = $(this).closest("tr").find(".score-col");

                if (selectedValue === "Yes" || selectedValue ===  "Met" ||selectedValue === "Meeting_expectations"||selectedValue ===  "exceeding expectations" ||selectedValue === "Partially Met") {
                    scoreCell.text(data[rowIndex].score);
                } else {
                    scoreCell.text(0);
                }
                calculateTotalScore();
            });

            calculateTotalScore();
        }

         function calculateTotalScore() {
          let isFatal = false;
            let total = 0;
            $("#sectionGrid tbody tr").each(function () {
                var scorable = $(this).find("td:nth-child(5)").text().trim(); // 5th column (scorable)
                var score = parseInt($(this).find(".score-col").text()) || 0;
                 var fatalValue = $(this).find(".fatal-select").val();

            if (fatalValue === "Yes" ) {
                isFatal = true;
            }
                if (scorable === "Yes") {
                    total += score;
                }
            });
            $("#totalScore").text(isFatal ? "0" : total);
        }
          function GetSectionGrid(program , subprogram)
           {
               
                $.ajax({
                    type: "POST",
                    url: "/ManageForm/GetSectionGried",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                   data: JSON.stringify({ SUBProcessID: subprogram, ProcessID: program }),
                    success: function (response) {
                      console.log(JSON.stringify(response));

                          populateGrid(response.sectionGrid, response.filteredRatingList);

                              $('#SectionGried').show();
                              $('#MasterCalibrator').show();

                    },
                    error: function (xhr, status, error) {
                        console.error("Error occurred: " + error);
                    }
                });
           }

        

</script>
