@model AgentFeedBackSectionList
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="card shadow mb-4" id="SectionGried" style="@(Model.sectionList.Any() ? "display:block" : "display:none")">
    <div class="card-header">
        <strong class="card-title">Form</strong>
    </div>
    <div class="card-body">
        <table id="sectionGrid" class="table table-bordered">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Level</th>
                    <th>Section Name</th>
                    <th>QA Rating</th>
                    <th>Scorable</th>
                    <th>Weightage</th>
                    <th>Comments Section</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.sectionList)
                {
                    <tr>
                        <td>@item.category</td>
                        <td>@item.level</td>
                        <td>@item.SectionName</td>
                    
             
                        <td>
                            <select class="qa-rating form-control">
                                <option value="">Select Rating</option>
                                @foreach (var rating in Model.filteredRatingList)
                                {
                     
                                    <option value="@rating.Value" selected="@(rating.Text == item.QA_rating.ToString() ? "selected" : null)">
                                        @rating.Text
                                    </option>
                                }
                            </select>
                        </td>
                        <td>@item.Scorable</td>
                        <td class="score-col">@item.Weightage</td>
                        <td>
                            <input type="text" class="form-control" placeholder="Enter Comments" value="@item.Commentssection">
                        </td>
                    </tr>
                }

                <tr>
                    <td colspan="5" class="text-right font-weight-bold">CQ Scores:</td>
                    <td id="totalScore" class="font-weight-bold">0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="col-md-12" style="display: flex; flex-direction: column; ">

    <div id="recordingContainer"></div>

</div>

<div class="col-md-12 my-4" id="AuditDiv">
    <div class="card shadow" style="border-radius: 10px; border: 1px solid #ddd;">
        <div class="card-body" style="padding: 20px;">
            <h5 class="card-title" style="font-weight: bold; color: #24294a;">Dispute Feedback </h5>
          

            <div class="row">
                <div class="form-group col-md-12">
                    <label for="QAComments" style="font-weight: 600; color: #333;">QA Comments</label> <span style="color:red">*</span>
                    <input type="text" value="@ViewBag.QA_Comments" id="QA_Comments" required
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; background-color: #f8f9fa; color: #555;">
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-12">
                    <label for="AgentComent" style="font-weight: 600; color: #333;">Agent Comments</label>
                    <input type="text" id="AgentComent" readonly value="@ViewBag.Agent_Comment"
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; color: #555;">
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-12">
                    <label for="AgentComent" style="font-weight: 600; color: #333;">Calibrated Comments</label> <span style="color:red">*</span>
                    <input type="text" id="Calibrated" placeholder="Enter your comments" required
                           style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; color: #555;">
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-2">
                    <button type="submit" onclick="submitDispute()"
                            style="background-color: #24294a; color: #fff; padding: 10px 15px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer;">
                        Acknowledge
                    </button>
                </div>
              
            </div>
        </div>
    </div>
</div>



<script src="~/js/jquery.min.js"></script>


<script src="~/js/jquery.min.js"></script>
<script>
    let sectionData = [];

    function InsertSectionAudit() {
        var isValid = true;
        var gridData = [];

        $("#sectionGrid tbody tr:not(:last-child)").each(function () {
            var $row = $(this);
            var category = $row.find("td:eq(0)").text().trim();
            var level = $row.find("td:eq(1)").text().trim();
            var sectionName = $row.find("td:eq(2)").text().trim();
            var qaRating = $row.find(".qa-rating").val();
            var scorable = $row.find("td:eq(4)").text().trim();
            var score = $row.find("td:eq(5)").text().trim();
            var comments = $row.find("input[type='text']").val().trim();

            if (category === "" && level === "" && sectionName === "") {
                return;
            }

            if (qaRating === "") {
                isValid = false;
                $row.find(".qa-rating").addClass("border border-danger");
            } else {
                $row.find(".qa-rating").removeClass("border border-danger");
            }

            if (comments === "") {
                isValid = false;
                $row.find("input[type='text']").addClass("border border-danger");
            } else {
                $row.find("input[type='text']").removeClass("border border-danger");
            }

            gridData.push({
                category: category,
                level: level,
                sectionName: sectionName,
                qaRating: qaRating,
                scorable: scorable,
                score: score,
                comments: comments,
                Transaction_ID: "",
                ProgramID: "",
                SUBProgramID: ""
            });
        });

        if (!isValid) {
            alert("Please select QA Rating and enter Comments In Section ");
            return false;
        }

        return gridData;
    }

    function initializeSectionData() {
        sectionData = [];

        $("#sectionGrid tbody tr:not(:last-child)").each(function () {
            var $row = $(this);
            var category = $row.find("td:eq(0)").text().trim();
            var level = $row.find("td:eq(1)").text().trim();
            var sectionName = $row.find("td:eq(2)").text().trim();
            var score = parseInt($row.find("td:eq(5)").text()) || 0;

            if (category === "" && level === "" && sectionName === "") {
                return;
            }

            sectionData.push({
                category: category,
                level: level,
                sectionName: sectionName,
                score: score
            });
        });
    }

    $(document).ready(function () {
        initializeSectionData();

        function calculateTotalScore() {
            let total = 0;

            $("#sectionGrid tbody tr").each(function () {
                var scorable = $(this).find("td:eq(4)").text().trim();
                var score = parseInt($(this).find(".score-col").text()) || 0;

                if (scorable === "Yes") {
                    total += score;
                }
            });

            $("#totalScore").text(total);
        }

        calculateTotalScore();

        $(".qa-rating").change(function () {
            var selectedValue = $(this).find("option:selected").text().trim();
            var $row = $(this).closest("tr");
        
            var scoreCell = $row.find(".score-col");
             var category = $row.find("td:eq(0)").text().trim();
    var level = $row.find("td:eq(1)").text().trim();
    var sectionName = $row.find("td:eq(2)").text().trim()

            if (
                selectedValue === "Yes" ||
                selectedValue === "Met" ||
                selectedValue === "Meeting_expectations" ||
                selectedValue === "exceeding expectations" ||
                selectedValue === "Partially Met"
            ) {
                let matchedItem = sectionData.find(x =>
                        x.category === category &&
                        x.level === level &&
                        x.sectionName === sectionName );

      

        scoreCell.text(matchedItem ? matchedItem.score : 0);
            } else {
                scoreCell.text(0);
            }

            calculateTotalScore();
        });

     
        $.ajax({
            type: "POST",
            data: JSON.stringify({ id: '@ViewBag.TransactionID' }),
            url: "/Monitor/GetRecording",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (!response.success) return;

                let container = document.getElementById("recordingContainer");
                container.innerHTML = "";

                container.style.cssText = `
                    background: url('/images/call_recording.jpg') center/cover no-repeat;
                    min-height: 300px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                    padding: 20px;
                `;

                if (!response.audioData) {
                    console.error("No audio data received.");
                    return;
                }

                try {
                    let byteCharacters = atob(response.audioData);
                    let byteNumbers = new Uint8Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }

                    let blob = new Blob([byteNumbers], { type: "audio/mpeg" });
                    let audioUrl = URL.createObjectURL(blob);

                    let audioPlayer = document.createElement("audio");
                    audioPlayer.controls = true;
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.cssText = `
                        width: 100%;
                        max-width: 439px;
                        margin: 5px auto;
                        margin-top: 527px;
                    `;
                    container.appendChild(audioPlayer);
                    audioPlayer.play().catch(console.error);
                } catch (e) {
                    console.error("Invalid Base64 audio data:", e);
                }
            },
            error: function (xhr, status, error) {
                console.error("Error occurred: " + error);
            }
        });
    });

    function submitDispute() {
        let sectionAuditData = InsertSectionAudit();
        if (!sectionAuditData) return;

        $.ajax({
            url: "/QAManager/InsertSectionAudit",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(sectionAuditData),
            success: function () { }
        });

        var calibration = $("#Calibrated").val();
        var QA_Comments = $("#QA_Comments").val().trim();
        var totalScore = $("#totalScore").text().trim();

        if (QA_Comments === "") {
            alert("Please enter a comment before acknowledging.");
            return;
        }

        $.ajax({
            url: '/QAManager/SubmitDisputeFeedbackByQA',
            type: 'POST',
            data: { comment: QA_Comments, calibration: calibration, totalScore: totalScore },
            success: function (response) {
                alert(response.message);
                $("#QA_Comments").val("");

                if (response.success) {
                    window.location.href = '/QAManager/Dashboard';
                }
            },
            error: function () {
                alert("Error submitting the comment.");
            }
        });
    }
</script>
