@model System.Data.DataTable

@using System.Data

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="col-md-12 my-4">
    <div class="card shadow">
        <div class="card-body">
            <h5 class="card-title">Welcome SuperAdmin</h5>
            <input type="hidden" id="accountId" />
            <table id="SuperAdminTable" class="table table-bordered table-hover mb-0">
                <thead>
                    <tr>
                        <th>AccountID</th>
                        <th>AccountName</th>
                        <th>Authantication_Type</th>
                        <th>Isactive</th>
                        <th>Create_date</th>
                        <th>Activate</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (System.Data.DataRow row in Model.Rows)
                    {
                        <tr>
                            <td>@row["AccountID"]</td>
                            <td>@row["AccountName"]</td>
                            <td>@row["Authantication_Type"]</td>
                            <td>@(row["Isactive"].ToString() == "1" ? "Yes" : "No")</td>
                            <td>@row["Create_date"]</td>
                            <td>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="chk_@row["AccountID"]"
                                    @(row["Isactive"].ToString() == "1" ? "checked" : "")
                                           onclick="updateStatus('@row["AccountID"]', this.checked)" />

                                    <label class="custom-control-label" for="chk_@row["AccountID"]"></label>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="userListModal" tabindex="-1" role="dialog" aria-labelledby="userListModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userListModalLabel">Users Associated with Account</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="userListContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveUserDeactivation()">Save Changes</button>
            </div>
        </div>
    </div>
</div>




<script>
    function updateStatus(accountId, isChecked) {
        var status = isChecked ? 1 : 0;

        saveAccountStatus(accountId, status);
        $('#accountId').val(accountId);
        $.ajax({
            type: "POST",
            url: "/SuperAdmin/GetUsersByAccount", 
            data: JSON.stringify({ accountId: accountId.trim() }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                console.log(response); 
                var users = response.data;
                var userListHtml = '<ul class="list-group">';

                users.forEach(function (user) {
                    var isActive = user.isactive === 1 ? "checked" : "";
                    userListHtml += `<li class="list-group-item">
                                           <input type="checkbox" id="user_${user.userID}" value="${user.userID}" ${isActive}>
                                       ${user.userName} - <strong>${user.usertype}</strong>
                                     </li>`;
                });

                userListHtml += '</ul>';
                $('#userListContent').html(userListHtml);
                $('#userListModal').modal('show');
            },
            error: function () {
                alert("Error fetching user list.");
            }
        });
    }

    function saveUserDeactivation() {
        var accountId = document.getElementById('accountId').value;

        if (!accountId) {
            alert("Account ID is missing.");
            return;
        }
        var updatedUsers = [];
        $('#userListContent input[type="checkbox"]').each(function () {
            var userId = $(this).val(); 
            if (userId) {
                var isActive = $(this).is(':checked') ? 1 : 0;
                updatedUsers.push({ userID: userId, isActive: isActive, accountId: accountId });
            }
        });

        if (updatedUsers.length === 0) {
            alert("No users selected for status update.");
            return;
        }
      
        console.log(JSON.stringify({ users: updatedUsers }));

        $.ajax({
            url: '/SuperAdmin/SaveUserDeactivation', 
            type: 'POST',
            data: JSON.stringify({ users: updatedUsers }),
            contentType: 'application/json',
            success: function (response) {
                alert("Users Active- deactive updated successfully.");
                location.reload();
            },
            error: function (xhr, status, error) {
                alert("An error occurred: " + error);
            }
        });
    }


    function saveAccountStatus(accountId, isChecked) {
        var status = isChecked ? 1 : 0;
        
        $.ajax({
            type: "POST",
            url: "/SuperAdmin/UpdateAccountStatus",
            data: JSON.stringify({ accountId: accountId, isActive: status }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {

            },
            error: function (xhr, status, error) {
                alert("Error updating account status.");
            }
        });
    }
</script>