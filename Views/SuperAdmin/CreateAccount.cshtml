@model System.Data.DataTable

@using System.Data

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="col-md-12 my-4">
    <div class="card shadow">
        <div class="card-body">
            <h5 class="card-title">Welcome SuperAdmin</h5>

            <table id="SuperAdminTable" class="table table-bordered table-hover mb-0">
                <thead>
                    <tr>
                        <th>AccountID</th>
                        <th style="color: black;">AccountName</th>
                        <th style="color: black;">Authantication_Type</th>
                        <th style="color: black;">Isactive</th>
                        <th style="color: black;">Create_date</th>
                        <th style="color: black;">Activate</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (System.Data.DataRow row in Model.Rows)
                    {
                        <tr>
                            <td>@row["AccountID"]</td>
                            <td>@row["AccountName"]</td>
                            <td>@row["Authantication_Type"]</td>
                            <td>@(row["Isactive"].ToString() == "1" ? "Yes" : "No")</td>
                            <td>@row["Create_date"]</td>
                            <td>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="chk_@row["AccountID"]"
                                    @(row["Isactive"].ToString() == "1" ? "checked" : "")
                                           onclick="updateStatus('@row["AccountID"]', this.checked)" />

                                    <label class="custom-control-label" for="chk_@row["AccountID"]"></label>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="userListModal" tabindex="-1" role="dialog" aria-labelledby="userListModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userListModalLabel">Users Associated with Account</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="userListContent">
                <!-- User list will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveUserDeactivation()">Save Changes</button>
            </div>
        </div>
    </div>
</div>




<script>
    // Function to update account status
    function updateStatus(accountId, isChecked) {
        var status = isChecked ? 1 : 0;
        
        saveAccountStatus(accountId, status);

        // Fetch users associated with the account
        $.ajax({
            type: "POST",
            url: "/SuperAdmin/GetUsersByAccount", // Ensure this URL is correct in your controller
            data: JSON.stringify({ accountId: accountId.trim() }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                console.log(response); // Check the response object structure
                var users = response.data;
                var userListHtml = '<ul class="list-group">';

                users.forEach(function (user) {
                    userListHtml += `<li class="list-group-item">
                                   <input type="checkbox" id="user_${user.userID}" value="${user.userID}">
                                   ${user.userName} - <strong>${user.usertype}</strong>
                                 </li>`;
                });

                userListHtml += '</ul>';
                $('#userListContent').html(userListHtml);
                $('#userListModal').modal('show');
            },
            error: function () {
                alert("Error fetching user list.");
            }
        });
    }

    // Function to save user deactivation changes
    function saveUserDeactivation() {
        var checkedUsers = [];   // Array for checked users
        var uncheckedUsers = []; // Array for unchecked users

        // Iterate over all checkboxes in the modal
        $('#userListContent input[type="checkbox"]').each(function () {
            var userId = $(this).val();
            if ($(this).prop('checked')) {
                checkedUsers.push(userId); // Add to checked users array
            } else {
                uncheckedUsers.push(userId); // Add to unchecked users array
            }
        });

        var data = { checkedUsers: checkedUsers, uncheckedUsers: uncheckedUsers };
        console.log(data); // Log the data being sent to the server

        // Send both arrays to the server
        $.ajax({
            type: "POST",
            url: "/SuperAdmin/DeactivateUsers", // Ensure this URL is correct in your controller
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function () {
                alert("Users' statuses updated successfully.");
                location.reload();
            },
            error: function () {
                alert("Error updating user statuses.");
            }
        });
    }

    // Function to save account status (active/inactive)
    function saveAccountStatus(accountId, isChecked) {
        var status = isChecked ? 1 : 0;

        $.ajax({
            type: "POST",
            url: "/SuperAdmin/UpdateAccountStatus", // Ensure this URL is correct in your controller
            data: JSON.stringify({ accountId: accountId, isActive: status }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                // Optionally handle the success response
            },
            error: function (xhr, status, error) {
                alert("Error updating account status.");
            }
        });
    }
</script>